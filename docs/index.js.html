<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>index.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-backend.html">backend</a><ul class='methods'><li data-type='method'><a href="module-backend.html#~authenticateToken">authenticateToken</a></li><li data-type='method'><a href="module-backend.html#~createUser">createUser</a></li><li data-type='method'><a href="module-backend.html#~generateToken">generateToken</a></li></ul></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// https://www.youtube.com/watch?v=T-Pum2TraX4&amp;ab_channel=JonathanSanchez
// npm run docs
import express from 'express';
import jwt from 'jsonwebtoken';

import {createUser,selectAllUsers,isEmailAlreadyRegistered,userNameEmailStep} from './db.js';
import nodemailer from 'nodemailer';

const app = express();
const transporter = nodemailer.createTransport({
  service: 'gmail',
  auth: {
    user: 'fagnernunes1108@gmail.com', // Your email
    pass: 'kcnj wyae ehov qgdl' // Your email password
  }
});

const JWT_SECRET = 'mysecret-key-test-123-fasfaf-f6254fdw95d46s58saf61afdfw0fw48df4d86f0asf48sa';
/**
 * @module backend
 * @description This is the backend module
 * @requires express
 * @requires db
 * @author Fagner Nunes
 * @version 1.0
 */


// Function to generate JWT
/**
 * @function generateToken
 * @description This function generates a token using the JWT library and a secret key. The token expires in 1 hour.
 * @param {*} data  // The data to be stored in the token
 * @returns // The generated token
 */
function generateToken(data) {
  return jwt.sign(data, JWT_SECRET, { expiresIn: '1h' });
}

/**
 * @function authenticateToken
 * @description This function authenticates the token sent by the user in the Authorization header. If the token is not present, it sends a 401 status code. If the token is not valid, it sends a 403 status code.
 * @param {*} req // The request object from Express  
 * @param {*} res // The response object from Express
 * @param {*} next // The next function to be called
 * @returns // The next function to be called or a status code if the token is not present or not valid.
 * 
 */
function authenticateToken(req, res, next) {
  const authHeader = req.headers['authorization'];
  console.log(`authHeader: ${authHeader}`);
  const token = authHeader &amp;&amp; authHeader.split(' ')[1]; // Bearer TOKEN
  console.log(`Token: ${token}`);
  if (token == null) return res.sendStatus(401); // If no token is present

  jwt.verify(token, JWT_SECRET, (err, user) => {
    if (err) return res.sendStatus(403); // If token is not valid
    req.user = user;
    next();
  });
}

/**
 * @function createUser
 * @description This function creates a new user
 * @param {string} name - The name of the user
 * @param {string} email - The email of the user
 * @param {string} password - The password of the user
 * @param {string} avatar - The avatar of the user
 * @returns {Promise&lt;void>}
 * 
 *
 */

/**
 * @api {get} /register/name-email/:name/:email Register a new user
 * @apiName RegisterUser
 * @apiGroup User
 * @apiVersion  1.0.0
 * @apiDescription This endpoint registers a new user with a name and an email address. The email address must be unique.
 * @apiParam {String} name The name of the user (required)  
 * @apiParam {String} email The email of the user (required)
 * @apiSuccess {Boolean} error The error status
 * @apiSuccess {String} errorMessage The error message
 * @apiSuccess {Object} data The user data
 * 
 */

// add params to the URL
app.get('/register/name-email/:name/:email', async (req, res) => {
     const name = req.params.name;
     const email = req.params.email;
     
     if (name &amp;&amp; email) {
          if(!email.includes('@') || !email.includes('.')){
              res.json({error:true,
                        errorMessage:'Invalid email',
                        data:null})
              ;}else if(await isEmailAlreadyRegistered(email)){

                res.json({error:true,
                          errorMessage:'Email already registered',
                          data:null})
                ;
              }
              else{
                // genenerate a random 4 digits number
                const randomNumber = Math.floor(Math.random() * 10000);
                //create timestamp for now 
                const timestamp = Date.now();
                console.log(`Random number: ${randomNumber}`);

                const response = userNameEmailStep(name, email, randomNumber, timestamp);
                
                // Send an email with the random number
                const mailOptions = {
                  from: 'fagnernunes1108@gmail.com', // Sender address
                  to: "fagnernunes11@gmail.com", // List of receivers
                  subject: 'Your Verification Code', // Subject line
                  text: `Your verification code is: ${randomNumber}` // Plain text body
                };

                // Send the email
                transporter.sendMail(mailOptions, async function(error, info){
                  if (error) { // If there is an error
                    
                    res.json({error: true, errorMessage: 'Failed to send email', data: null});
                  } else {
                    console.log('Email sent: ' + info.response);
                    const data = await userNameEmailStep(name, email, randomNumber, timestamp);
                    const token = generateToken(data);
                    let response = {error: false, errorMessage: null,token:token, data: data};
                    console.log(`Responding with: `, response);
                    res.json(response);
                  }
                });
              }

              
              }

     else {
         res.json({error:true,
                    errorMessage:'Name and email are required',
                    data:null})
         }});
    //createUser(req.params.name, req.params.email, 'securePassword123', 'http://example.com/avatar.jpg');



/**
 * @api {get} /register/confirmation-code/:code Register a new user 
 * @apiName RegisterUser
 * @apiGroup User
 * @apiVersion  1.0.0
 * @apiDescription This endpoint is used to confirm the registration of a new user. The user must provide the confirmation code that was sent to the email address.
 * @apiParam {String} code The confirmation code sent to the user's email address
 * @apiSuccess {Boolean} error The error status
 * @apiSuccess {String} errorMessage The error message
 * @apiSuccess {Object} data The user data
 * 
*/

app.get('/register/confirmation-code/:code',authenticateToken, async (req, res) => {
  const code = req.params.code;
  console.log(`Code: ${code}`);
  res.json({code});
  // get the user data from the token

});

/**
 * @api {get} /select-all-users Select all users
 * @apiName SelectAllUsers
 * @apiGroup User
 * @apiVersion  1.0.0
 * @apiDescription This endpoint selects all users from the database.
 * @apiSuccess {Array} users An array of user objects
 * 
 */
app.get('/select-all-users', async (req, res) => {
  const users = await selectAllUsers();
  res.json({users});
})


app.listen(5001, () => {console.log('Server is running on port 5001')});

app.get('/', (req, res) => res.json({message: 'Hello World'}))  // http://localhost:5001/</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.3</a> on Thu Jun 13 2024 20:32:24 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
